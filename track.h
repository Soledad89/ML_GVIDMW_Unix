
//******************************
//
//  author : lishidan
//
//  create time: 2007-10-10
//
//  last modify time:2008-2-19
//
//  Version: 1.5
//
//******************************

#ifndef __TRACK_H__
#define __TRACK_H__

#include "trace.h"
#include "datapool.h"
#include "layers.h"
#include "painter.h"

#include <math.h>
#include <list>

typedef std::list<CTrace> ListTargets;
typedef ListTargets::iterator ListTargetsIte;


typedef struct int_trace
{
	int batchNum;// 目标批号
	int attr;// 目标属性：敌0、友1、中立2、不明3，四类
	int type;// 目标类型：空中0、水面1、水下2，三类
	
	float dis;// 距离，单位：米
	float azi;// 方位，单位：度
	float moveAzi;// 航向，单位：度
	float speed;// 航速，单位：米/秒
}int_trace;


const DISPMEMTYPE targetColor[]={MFB_RED,MFB_BLUE,MFB_GREEN,0xf81f};

class CTrack
{
		
public:
	CTrack(CDataPool *m_dp);
	~CTrack();

public:
	int vecType; //矢量类型: 0  真矢量；1  相对矢量
	int vecTime;// 单位：分钟； 范围：1～60

	ListTargets targets;//航迹
	DeqTrace dotTrace;//点迹

	CDataPool *dp;

	// use for trace
    CLayerBase *layerS4;
    CLayerBase *layerR4;
    
 	CPainter *painter;
 	CPainter *eraser;

	// use for dots
	CLayerBase *layerS3;
	CLayerBase *layerR3;

	CPainter *dotPainter;
	CPainter *dotEraser;

	bool frozen;

    float CPA;
    float TCPA;

	float range;// unit m

	unsigned int traceDotsNum;//每条航迹中航迹点的数目
	int traceNum;//当前航迹数目
	int infoBatchNum;//当前显示航迹信息的目标批号，-1表示无航迹信息显示

	int dotsNum;//屏幕上点迹的总数目，与航迹无关
	DISPMEMTYPE dotColor;

public:

	void trackUpdate(int_trace info);
	
	int targetWithdraw(int bn);
	int targetWithdraw(int x,int y);
	int cancelInfoDisplay();
	int targetInfoDisplay(int x,int y,bool flag);// flag true is display,flag false is clear
	int targetInfoDisplay(int bn,bool flag);
	int targetInfoDisplay(ListTargetsIte ite,bool flag);

	void drawAllTraces();
	void clearAllTraces();
	void drawSingleTrace(ListTargetsIte ite);
	void clearSingleTrace(ListTargetsIte ite);
	void frozeTrack();

    void updateAllTraces();
	void updateSomeTraces(int xleft,int yup,int xrtight,int ydown);

	void redrawAllTraces();
	void redrawSomeTraces(int xleft,int yup,int xrtight,int ydown);

	void targetsCheck();
	//---- dots ----
	void dotUpdate(float d,float a);// 距离d，单位：米; 方位a，单位：度
	void updateAllDots();
	void drawAllDots();
	void clearAllDots();

	void updateFbp();
	void setRange(float r);

private:
	ListTargetsIte findTarget(int batchNum);
	ListTargetsIte findTarget(int x,int y);
	
	void insertTraceNode(ListTargetsIte ite, int_trace &info);
	void updateTraceData(ListTargetsIte ite);
	void updateTraceData(DeqTraceIte ite);

	void drawTargetIcon(int x,int y,int attr,int type);
	void clearTargetIcon(int x,int y,int attr,int type);
	void drawInfoRect(int x,int y,int bn,float f1,float f2);
	void clearInfoRect(int x,int y,int bn,float f1,float f2);

};



/////////////////////////////////////////////////////////////////////////
// Bitmap点阵数据表                                                 //
// 图片: C:\..桌面\info.bmp,横向取模左高位,数据排列:从左到右从上到下   //
// 图片尺寸: 160 * 78                                                                                 //
/////////////////////////////////////////////////////////////////////////
#define INFO_WIDTH 160
#define INFO_HEIGHT 78
#define INFO_X 34
#define INFO_Y1 8
#define INFO_Y2 31
#define INFO_Y3 54

const unsigned char infoBitmapDot[] =                  // 数据表
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7C,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7E,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7E,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7F,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7F,0x78,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7F,0x78,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7F,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7B,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7B,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x79,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x79,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x79,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x78,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x78,0xF8,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x0F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x1F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x1F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x00,0x08,
	0x40,0x1F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x04,0x40,0x00,0x00,0x00,0x00,0x08,
	0x40,0x3F,0xE0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x08,0x20,0x00,0x00,0x00,0x00,0x08,
	0x40,0x3F,0xE0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x08,0x20,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7D,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x08,0x20,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7D,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x04,0x40,0x00,0x00,0x00,0x00,0x08,
	0x40,0x7D,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x00,0x08,
	0x40,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0xFF,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0xFF,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x41,0xF0,0x7C,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x41,0xF0,0x7C,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x41,0xF0,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x41,0xF0,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xE0,0x00,0x08,
	0x40,0xF0,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xC0,0x00,0x08,
	0x40,0xF8,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x00,0x08,
	0x40,0xF8,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xDE,0x78,0x03,0xC1,0xFE,0x08,
	0x40,0x78,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xFF,0xFC,0x07,0xC3,0xFE,0x08,
	0x40,0x7D,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xFF,0xFC,0x07,0x83,0xE6,0x08,
	0x40,0x7D,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x07,0x83,0xE0,0x08,
	0x40,0x3D,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x0F,0x03,0xFC,0x08,
	0x40,0x3F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x0F,0x03,0xFE,0x08,
	0x40,0x1F,0xC0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x1E,0x01,0xFE,0x08,
	0x40,0x1F,0xC0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x1E,0x02,0x3E,0x08,
	0x40,0x1F,0xC0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x1E,0x03,0xBE,0x08,
	0x40,0x0F,0x80,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x3C,0x03,0xFE,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xCF,0x3C,0x3C,0x03,0xFC,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,
	0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


#endif
